version: '3.8'

services:
  postgres-test:
    image: postgres:16-alpine
    container_name: pulpulitiko-postgres-test
    environment:
      POSTGRES_USER: politics
      POSTGRES_PASSWORD: testpassword
      POSTGRES_DB: politics_test_db
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U politics"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network
    volumes:
      - postgres-test-data:/var/lib/postgresql/data

  redis-test:
    image: redis:7-alpine
    container_name: pulpulitiko-redis-test
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test-network

  api-test:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: pulpulitiko-api-test
    environment:
      DATABASE_URL: postgres://politics:testpassword@postgres-test:5432/politics_test_db?sslmode=disable
      REDIS_URL: redis-test:6379
      JWT_SECRET: test-jwt-secret
      ENVIRONMENT: test
      PORT: 8080
    ports:
      - "8081:8080"
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - test-network
    command: >
      sh -c "
        /usr/local/bin/migrate -path /app/migrations -database postgres://politics:testpassword@postgres-test:5432/politics_test_db?sslmode=disable up &&
        go test -v -race -coverprofile=coverage.out ./... &&
        go tool cover -func=coverage.out
      "

  web-test:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: test
    container_name: pulpulitiko-web-test
    environment:
      NUXT_PUBLIC_API_URL: http://api-test:8080
      NODE_ENV: test
    networks:
      - test-network
    command: npm run test:run

networks:
  test-network:
    driver: bridge

volumes:
  postgres-test-data:
