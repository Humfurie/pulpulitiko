name: Integration Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  docker-integration:
    name: Docker Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          POSTGRES_USER=politics
          POSTGRES_PASSWORD=testpassword
          POSTGRES_DB=politics_test_db
          POSTGRES_PORT=5432

          REDIS_PORT=6379

          JWT_SECRET=test-jwt-secret-key-for-integration-tests

          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin
          MINIO_ENDPOINT=minio.humfurie.org
          MINIO_BUCKET=pulpulitiko-test

          API_PORT=8080
          WEB_PORT=3000

          ENVIRONMENT=test
          EOF

      - name: Build Docker images
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml build --no-cache

      - name: Start services
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml up -d postgres redis minio
          echo "Waiting for services to be ready..."
          sleep 10

      - name: Check service health
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml ps
          docker exec pulpulitiko-postgres pg_isready -U politics || exit 1
          docker exec pulpulitiko-redis redis-cli ping || exit 1
          echo "Checking MinIO health..."
          timeout 30 sh -c 'until curl -f http://localhost:9000/minio/health/live > /dev/null 2>&1; do sleep 2; done' || echo "MinIO health check skipped"

      - name: Run database migrations
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml up -d api
          sleep 5
          docker exec pulpulitiko-api /usr/local/bin/migrate \
            -path /app/migrations \
            -database "postgres://politics:testpassword@postgres:5432/politics_test_db?sslmode=disable" \
            up

      - name: Seed test data
        run: |
          docker exec -e ADMIN_EMAIL=test@example.com \
                     -e ADMIN_PASSWORD=TestPassword123! \
                     -e ADMIN_NAME="Test Admin" \
                     pulpulitiko-api /app/seed || echo "Seed skipped or failed"

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to be ready..."
          timeout 60 sh -c 'until curl -f http://localhost:8080/health > /dev/null 2>&1; do sleep 2; done'
          echo "API is ready!"

      - name: Start frontend
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml up -d web
          sleep 10

      - name: Run integration tests
        run: |
          # Test API health endpoint
          echo "Testing API health..."
          curl -f http://localhost:8080/health

          # Test API public endpoints
          echo "Testing API public endpoints..."
          curl -f http://localhost:8080/api/articles || echo "Warning: Articles endpoint returned error"
          curl -f http://localhost:8080/api/politicians || echo "Warning: Politicians endpoint returned error"

          # Test frontend
          echo "Testing frontend..."
          timeout 60 sh -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
          echo "Frontend is accessible!"

      - name: Check logs for errors
        if: always()
        run: |
          COMPOSE_CMD="docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml"

          echo "=== API Logs ==="
          $COMPOSE_CMD logs api --tail 100

          echo "=== Web Logs ==="
          $COMPOSE_CMD logs web --tail 100

          echo "=== Postgres Logs ==="
          $COMPOSE_CMD logs postgres --tail 50

          echo "=== Redis Logs ==="
          $COMPOSE_CMD logs redis --tail 50

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml down -v
          rm -f .env

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: docker-integration

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          POSTGRES_USER=politics
          POSTGRES_PASSWORD=testpassword
          POSTGRES_DB=politics_test_db
          POSTGRES_PORT=5432
          REDIS_PORT=6379
          JWT_SECRET=test-jwt-secret-key-for-integration-tests
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin
          MINIO_ENDPOINT=minio.humfurie.org
          MINIO_BUCKET=pulpulitiko-test
          API_PORT=8080
          WEB_PORT=3000
          ENVIRONMENT=test
          EOF

      - name: Start test environment
        run: |
          # Start dependencies first
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml up -d postgres redis minio
          echo "Waiting for dependencies..."
          sleep 10
          # Start application services
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml up -d api web
          echo "Waiting for services..."
          sleep 30

      - name: Install Playwright
        working-directory: ./web
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Run Playwright e2e tests
        working-directory: ./web
        env:
          BASE_URL: http://localhost:3000
        run: |
          # This would run actual Playwright tests if they exist
          echo "E2E tests would run here with Playwright"
          echo "BASE_URL is set to: $BASE_URL"
          # npx playwright test

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web/playwright-report/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.prod.yml -f docker-compose.ci.yml down -v
          rm -f .env
